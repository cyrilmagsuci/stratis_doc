

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>The Auction Smart Contract &mdash; Stratis Academy  documentation</title>
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet">
  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Testing Locally with TestChain" href="testing-locally-with-testchain.html" />
    <link rel="prev" title="Smart Contracts In-Depth" href="contracts-in-depth.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Stratis Academy
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Blockchain%20Overview/blockchain-overview-introduction.html">Blockchain Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../architecture-reference-introduction.html">Architecture Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../FullNode/full-node-introduction.html">Full Node</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="smartcontracts-introduction.html">Smart Contracts</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="smart-contracts-basic-theory.html">Basic Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="uses-of-smart-contracts.html">Uses of Smart Contracts</a></li>
<li class="toctree-l3"><a class="reference internal" href="account-abstraction-layer.html">Account Abstraction Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="working-with-contracts.html">Working with Contracts</a></li>
<li class="toctree-l3"><a class="reference internal" href="contracts-in-depth.html">Smart Contracts In-Depth</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">The Auction Smart Contract</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing-locally-with-testchain.html">Testing Locally with TestChain</a></li>
<li class="toctree-l3"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="appendix-future-enhancements-to-smart-contracts.html">Appendix - Future Enhancements to Stratis Smart Contracts</a></li>
<li class="toctree-l3"><a class="reference internal" href="appendix-gas-prices.html">Appendix - Gas Prices and Memory Limit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Sidechains/sidechains-introduction.html">Sidechains</a></li>
<li class="toctree-l2"><a class="reference internal" href="../DLT/dlt-introduction.html">DLT</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer%20Resources/developers-introduction.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Operation%20Guides/operation-guides-introduction.html">Operation Guides</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Stratis Academy</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../architecture-reference-introduction.html">Architecture Reference</a> &raquo;</li>
        
          <li><a href="smartcontracts-introduction.html">Stratis Smart Contracts</a> &raquo;</li>
        
      <li>The Auction Smart Contract</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/Architecture Reference/SmartContracts/auction-smart-contract.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="the-auction-smart-contract">
<h1>The Auction Smart Contract<a class="headerlink" href="#the-auction-smart-contract" title="Permalink to this heading">¶</a></h1>
<p>This chapter takes a further look at the smart contract-specific parts of an Auction C# class. You can check out the complete source <a class="reference external" href="https://github.com/stratisproject/StratisSmartContractsSamples/blob/master/src/Stratis.SmartContracts.Samples/Stratis.SmartContracts.Samples/Auction.cs">here</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">using</span> <span class="n">Stratis</span><span class="o">.</span><span class="n">SmartContracts</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">Auction</span> <span class="p">:</span> <span class="n">SmartContract</span>
</pre></div>
</div>
<p>The first line in the contract is a reference to the <code class="docutils literal notranslate"><span class="pre">Stratis.SmartContracts</span></code> NuGet package. This package allows you to inherit from the <code class="docutils literal notranslate"><span class="pre">SmartContract</span></code> class and thereby provides subclasses with useful functionality such as sending funds, hashing, and saving data. You can create smart contracts just by including the <code class="docutils literal notranslate"><span class="pre">Stratis.SmartContracts</span></code> NuGet package in your project and inheriting from <code class="docutils literal notranslate"><span class="pre">SmartContract</span></code>.</p>
<p>The only libraries that can be included in the current iteration of Stratis smart contracts are <code class="docutils literal notranslate"><span class="pre">System</span></code>, <code class="docutils literal notranslate"><span class="pre">System.Linq</span></code> and <code class="docutils literal notranslate"><span class="pre">Stratis.SmartContracts</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">Address</span> <span class="n">Owner</span>
<span class="p">{</span>
  <span class="n">get</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="n">PersistentState</span><span class="o">.</span><span class="n">GetObject</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;Owner&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">private</span> <span class="nb">set</span>
  <span class="p">{</span>
      <span class="n">PersistentState</span><span class="o">.</span><span class="n">SetObject</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span><span class="p">(</span><span class="s2">&quot;Owner&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Auction object has several properties which are structured in a similar way to the Owner property. To persist data in a smart contract, use <code class="docutils literal notranslate"><span class="pre">PersistentState</span></code>. Data can be persisted anywhere in the smart contract not just inside a property. However, persisting data inside properties makes the code inside your methods easier to read.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Address</span></code> class is included as part of <code class="docutils literal notranslate"><span class="pre">Stratis.SmartContracts</span></code>. It is an abstraction over a series of strings that enables funds to be sent to addresses.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>public ulong GetBalance(Address address)
{
    return this.PersistentState.GetUInt64($&quot;Balances[{address}]&quot;);
}

private void SetBalance(Address address, ulong balance)
{
    this.PersistentState.SetUInt64($&quot;Balances[{address}]&quot;, balance);
}
</pre></div>
</div>
<p>The above methods emulate a dictionary-like structure for storage. Using a standard .NET dictionary would require serializing and deserializing all the dictionary data every time it was updated. For dictionaries with thousands of entries (think balances of a token contract), this would require a significant amount of processing. These methods instead store individual items in the underlying key/value store.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="n">Auction</span><span class="p">(</span><span class="n">ISmartContractState</span> <span class="n">smartContractState</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">durationBlocks</span><span class="p">)</span>
 <span class="p">:</span> <span class="n">base</span><span class="p">(</span><span class="n">smartContractState</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="n">Owner</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">Sender</span><span class="p">;</span>
     <span class="n">EndBlock</span> <span class="o">=</span> <span class="n">Block</span><span class="o">.</span><span class="n">Number</span> <span class="o">+</span> <span class="n">durationBlocks</span><span class="p">;</span>
     <span class="n">HasEnded</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>The contract constructor gets run when the contract is created for the first time. Contracts must override the base class constructor and inject <code class="docutils literal notranslate"><span class="pre">ISmartContractState</span></code>, which must be the first parameter of the constructor. Other parameters should be positioned after this parameter.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Message</span></code> and <code class="docutils literal notranslate"><span class="pre">Block</span></code> objects are read-only properties on the <code class="docutils literal notranslate"><span class="pre">SmartContract</span></code> class which the Auction class inherits from. These properties provide access to information about the current context that a contract call is executing in. For example: block numbers, the address that called the contract, etc.</p>
<p>Assigning a value to <code class="docutils literal notranslate"><span class="pre">Owner</span></code>, <code class="docutils literal notranslate"><span class="pre">EndBlock</span></code>, and <code class="docutils literal notranslate"><span class="pre">HasEnded</span></code> saves the values in <code class="docutils literal notranslate"><span class="pre">PersistentState</span></code> via their property setters. Setting <code class="docutils literal notranslate"><span class="pre">Owner</span></code> is a very common pattern when developing smart contracts and gives extra functionality to the creator of the contract. You will notice that in the <code class="docutils literal notranslate"><span class="pre">AuctionEnd</span></code> method, funds are sent to <code class="docutils literal notranslate"><span class="pre">Owner</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Assert</span></code> method, inherited from <code class="docutils literal notranslate"><span class="pre">SmartContract</span></code>, provides a simple way to reject contract executions that don’t meet certain criteria. In this case, we’re using it to reject any further execution when the message sender doesn’t have a balance in our contract.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Transfer</span></code> method, also inherited from <code class="docutils literal notranslate"><span class="pre">SmartContract</span></code>, enables the sending of funds to a specific address. This will send funds to ordinary addresses or contracts. A third parameter can be specified as input for this method to give more information about the method etc. to call on a contract.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>public bool Withdraw()
{
    ulong amount = GetBalance(this.Message.Sender);
    Assert(amount &gt; 0);
    SetBalance(this.Message.Sender, 0);
    ITransferResult transferResult = Transfer(this.Message.Sender, amount);
    if (!transferResult.Success)
        this.SetBalance(this.Message.Sender, amount);
    return transferResult.Success;
}
</pre></div>
</div>
<p>There are a few more methods in the <code class="docutils literal notranslate"><span class="pre">Auction</span></code> class, but the final method to look at is <code class="docutils literal notranslate"><span class="pre">Withdraw</span></code>. This method checks whether the caller has a balance to withdraw from. If they do, this balance will be deducted from the smart contract state and they will be sent the funds.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may be wondering why there is a <code class="docutils literal notranslate"><span class="pre">Withdraw</span></code> method at all. Why not just transfer the funds to their owner as soon as they become available? The reason is because the owner of these funds could be another smart contract that cannot be controlled. Sending the funds back to such a contract would potentially call unknown code using another user’s funds. Therefore, the <code class="docutils literal notranslate"><span class="pre">Withdraw</span></code> pattern is very common in smart contracts. If users call a contract, that contract execution should never execute an untrusted smart contract’s code.</p>
</div>
</section>


           </div>
           
          </div>
          
        </div>
      </div>
      <footer class="footer-container">
  <div class="footer-pagination">
    
      <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        
          <a href="testing-locally-with-testchain.html" class="btn btn-primary float-right" title="Testing Locally with TestChain" accesskey="n" rel="next">Next <span class="fa fa-arrow-right"></span></a>
        
        
          <a href="contracts-in-depth.html" class="btn btn-neutral" title="Smart Contracts In-Depth" accesskey="p" rel="prev"><span class="fa fa-arrow-left"></span> Previous</a>
        
      </div>
    
  </div>

  <div role="contentinfo" class="footer-copyright">
    <div class="footer-logo-copyright">
      <img src="../../_static/img/footer-logo.png" alt="Stratis" class="footer-logo">
      <p>
          &copy; Copyright 2020, Stratis Group Ltd.

      </p>
    </div>

    <div class="footer-links">
      <a class="footer-social-link" href="https://twitter.com/stratisplatform" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
      <a class="footer-social-link" href="https://github.com/stratisproject" target="_blank"><i class="fa fa-github-alt" aria-hidden="true"></i></a>
      <a class="footer-social-link" href="https://discord.gg/9tDyfZs" target="_blank"><img src="../../_static/img/discord.png" alt="Discord" style="width: 26px; height: 26px;"></a>
    </div>

    <div style="clear: both;"></div>
  </div> 

</footer>


      <div style="clear: both;"></div>
    </section>
    
  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            LANGUAGE:'en',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/sphinx_highlight.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>